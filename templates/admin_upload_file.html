{% extends "base.html" %}

{% block title %}Admin - Upload File{% endblock %}

{% block content %}
<div class="text-white">
    <div class="container mx-auto px-4 py-12 mb-[20rem]">
        <div class="max-w-6xl mx-auto">
            <h1 class="text-4xl font-bold text-center mb-6">Document Protection & Watermarking</h1>
            <p class="text-gray-400 text-lg text-center mb-8">Secure your sensitive documents with enterprise-grade watermarking.</p>

            <!-- Upload Section -->
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                <form id="upload-form" enctype="multipart/form-data" class="space-y-4">
                    <input type="file" id="file" name="file" accept="application/pdf" required class="w-full p-2 border border-gray-700 bg-gray-700 text-white rounded-lg">
                    <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg">Upload</button>
                </form>
            </div>

            <!-- Files List -->
            <div class="p-6 rounded-lg shadow-lg mt-8 mb-20">
                <h2 class="text-xl font-semibold mb-4">Previously Uploaded Documents</h2>
                <div id="admin-files" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
                    <!-- List of files will load here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function loadFiles() {
        const response = await fetch('/files');
        const result = await response.json();
        const container = document.getElementById('admin-files');
        container.innerHTML = '';
        if (response.ok && result.files) {
            result.files.forEach(fileObj => {
                const div = document.createElement('div');
                div.className = "bg-gray-800 w-44 h-20 rounded-lg flex flex-col items-center justify-between p-2 shadow-lg";
                
                const title = document.createElement('div');
                title.textContent = fileObj.filename;
                title.className = "text-white text-xs truncate w-full text-center";
                div.appendChild(title);
                
                const btnContainer = document.createElement('div');
                btnContainer.className = "flex space-x-2 mt-2";
                
                // Changed: Add small "Download" button
                const downloadBtn = document.createElement('button');
                downloadBtn.textContent = "Download";
                downloadBtn.title = "Download";
                downloadBtn.className = "bg-blue-400 text-white px-2 py-1 rounded text-xs hover:bg-blue-500";
                downloadBtn.addEventListener('click', () => downloadFile(fileObj.filename, false));
                btnContainer.appendChild(downloadBtn);
                
                // Changed: Add small "Watermark" button
                const watermarkBtn = document.createElement('button');
                watermarkBtn.textContent = "Watermark";
                watermarkBtn.title = "Download with Watermark";
                watermarkBtn.className = "bg-green-400 text-white px-2 py-1 rounded text-xs hover:bg-green-500";
                watermarkBtn.addEventListener('click', () => downloadFile(fileObj.filename, true));
                btnContainer.appendChild(watermarkBtn);
                
                div.appendChild(btnContainer);
                container.appendChild(div);
            });
        } else {
            container.innerHTML = '<p class="col-span-6 text-center text-gray-500">No files available.</p>';
        }
    }
    
    async function downloadFile(filename, watermark) {
        const url = watermark 
            ? '/download/' + encodeURIComponent(filename)  // changed endpoint for watermark downloads
            : '/uploads/' + encodeURIComponent(filename);
        try {
            console.log(url);
            
            const response = await fetch(url);
            if(!response.ok) {
                alert('Download failed');
                return;
            }
            const blob = await response.blob();
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(a.href);
        } catch (error) {
            alert('Download failed');
        }
    }
    
    document.getElementById('upload-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const file = document.getElementById('file').files[0];
        const formData = new FormData();
        formData.append('file', file);
        const response = await fetch('/upload', { method: 'POST', body: formData });
        const result = await response.json();
        alert(response.ok ? result.message : result.error);
        if (response.ok) loadFiles();
    });
    
    document.addEventListener("DOMContentLoaded", loadFiles);
</script>
{% endblock %}
