{% extends "base.html" %}

{% block title %}Admin - Upload File{% endblock %}

{% block content %}
<div id="flash-message" class=" z-100 hidden fixed top-0 left-1/2 transform -translate-x-1/2 mt-4 w-11/12 max-w-md"></div>

<div class="text-black">
    <div class="container mx-auto px-4 py-12 mb-[20rem]">
        <div class="max-w-6xl mx-auto">
            <h1 class="text-4xl font-bold text-center mb-6">Document Protection & Watermarking</h1>
            <p class="text-gray-400 text-lg text-center mb-8">Secure your sensitive documents with enterprise-grade watermarking.</p>

            <!-- Upload Section -->
            <div class=" p-6 rounded-lg ">
                <form id="upload-form" enctype="multipart/form-data" class="space-y-4">
                    <input type="file" id="file" name="file" accept="application/pdf" required class="w-full p-2 border border-orange-700 bg-white text-black rounded-lg">
                    <button type="submit" class="w-full bg-orange-500 hover:bg-orange-600 text-white py-2 px-4 rounded-lg">Upload</button>
                </form>
            </div>

            <!-- Files List -->
            <div class="p-6 rounded-lg border border-amber-400 mt-8 mb-20 flex flex-wrap flex-col justify-center">
                <h2 class="text-xl text-center font-semibold mb-4">Previously Uploaded Documents</h2>
                <div id="admin-files" class="flex-wrap flex justify-center items-center gap-4">
                    <!-- List of files will load here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function loadFiles() {
        const response = await fetch('/files');
        const result = await response.json();
        const container = document.getElementById('admin-files');
        container.innerHTML = '';
        if (response.ok && result.files) {
            result.files.forEach(fileObj => {
                const div = document.createElement('div');
                div.className = "relative bg-white border border-orange-500 w-56 h-20 rounded-lg flex flex-col items-center justify-between p-2 ";
                
                // Update delete icon to use the provided image URL
                const deleteIcon = document.createElement('button');
                deleteIcon.innerHTML = '<img src="https://cdn.iconscout.com/icon/free/png-256/free-delete-icon-download-in-svg-png-gif-file-formats--remove-trash-cancel-garbage-user-interface-pack-icons-2411575.png" alt="Delete" class="w-4 h-4">';
                deleteIcon.title = "Delete file";
                deleteIcon.style.position = "absolute";
                deleteIcon.style.top = "4px";
                deleteIcon.style.right = "4px";
                deleteIcon.style.background = "none";
                deleteIcon.style.border = "none";
                deleteIcon.style.cursor = "pointer";
                deleteIcon.addEventListener('click', () => deleteFile(fileObj.filename));
                div.appendChild(deleteIcon);
                
                const title = document.createElement('div');
                title.textContent = fileObj.filename;
                title.className = "text-black text-xs truncate w-full text-center";
                div.appendChild(title);
                
                const btnContainer = document.createElement('div');
                btnContainer.className = "flex space-x-2 mt-2";
                
                // Add small "Download" button
                const downloadBtn = document.createElement('button');
                downloadBtn.textContent = "Download";
                downloadBtn.title = "Download";
                downloadBtn.className = "bg-orange-400 text-white px-2 py-1 rounded text-xs hover:bg-blue-500";
                downloadBtn.addEventListener('click', () => downloadFile(fileObj.filename));
                btnContainer.appendChild(downloadBtn);
                
                // Add small "View" button
                const viewBtn = document.createElement('button');
                viewBtn.textContent = "View";
                viewBtn.title = "View PDF";
                viewBtn.className = "bg-green-400 text-white px-2 py-1 rounded text-xs hover:bg-green-500";
                viewBtn.addEventListener('click', () => viewFile(fileObj.filename));
                btnContainer.appendChild(viewBtn);

                // Add small "Make Demo" button
                const demoBtn = document.createElement('button');
                demoBtn.textContent = fileObj.demo_type ? "Already Demo" : "Make Demo";
                demoBtn.title = "Make Demo";
                demoBtn.className = "bg-yellow-400 text-white px-2 py-1 rounded text-xs hover:bg-yellow-500";
               
                demoBtn.addEventListener('click', () => makeDemo(fileObj.filename, demoBtn));
                btnContainer.appendChild(demoBtn);
                
                div.appendChild(btnContainer);
                container.appendChild(div);
            });
        } else {
            container.innerHTML = '<p class="col-span-6 text-center text-gray-500">No files available.</p>';
        }
    }
    
    async function downloadFile(filename) {
        const url = '/uploads/' + encodeURIComponent(filename);
        try {
            const response = await fetch(url);
            if(!response.ok) {
                alert('Download failed');
                return;
            }
            const blob = await response.blob();
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(a.href);
        } catch (error) {
            alert('Download failed');
        }
    }

    function viewFile(filename) {
        const url = '/uploads/' + encodeURIComponent(filename);
        window.open(url, '_blank');
    }

    async function deleteFile(filename) {
        const url = '/delete/' + encodeURIComponent(filename);
        try {
            const response = await fetch(url, { method: 'DELETE' });
            const result = await response.json();
            alert(response.ok ? result.message : result.error);
            if (response.ok) loadFiles();
        } catch (error) {
            alert('Delete failed');
        }
    }

    async function makeDemo(filename, button) {
        const url = '/set_demo/' + encodeURIComponent(filename);
        try {
            const response = await fetch(url, { method: 'POST' });
            const result = await response.json();
            alert(response.ok ? result.message : result.error);
            if (response.ok) {
                
                button.textContent = result.demo_type ? "Already Demo" : "Make Demo";
            }
        } catch (error) {
            alert('Failed to set demo type');
        }
    }
    
    document.getElementById('upload-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const file = document.getElementById('file').files[0];
        const formData = new FormData();
        formData.append('file', file);
        const response = await fetch('/upload', { method: 'POST', body: formData });
        const result = await response.json();
        alert(response.ok ? result.message : result.error);
        if (response.ok) loadFiles();
    });
    
    document.addEventListener("DOMContentLoaded", loadFiles);
</script>
{% endblock %}
