{% extends "base.html" %}
{% block title %}Document Manager{% endblock %}

{% block content %}

<!-- Main Content -->
<div id="flash-message" class=" z-100 hidden fixed top-0 left-1/2 transform -translate-x-1/2 mt-4 w-11/12 max-w-md "></div>

<div class="container mx-auto px-4 py-8 ">
    <div class="flex flex-col md:flex-row justify-center items-center mb-8 gap-4">
        <div>
            <h1 class="text-3xl font-bold mb-2 text-center">All Files </h1>
            <p class="text-black text-center">Manage and protect your sensitive documents</p>
        </div>
    </div>

    <!-- Search Bar -->
    <div class="relative mb-8">
        <input id="search" type="text" placeholder="Search documents..." 
            class="pl-10 bg-white border border-orange-500 text-black w-full p-3 rounded-md" />
    </div>

    <!-- Documents Grid -->
    <div id="documents-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-20">
        <!-- Documents will be dynamically inserted here -->
    </div>

    <!-- No Results Message -->
    <p id="no-results" class="text-gray-400 text-center mt-4 hidden mb-20">No matching documents found.</p>
</div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', async function() {
        const searchInput = document.getElementById('search');
        const container = document.getElementById("documents-container");
        const noResultsMessage = document.getElementById("no-results");
        let filesData = [];

        async function loadFiles() {
            try {
                const response = await fetch("/files");
                const result = await response.json();
                filesData = result.files || [];
                renderFiles(filesData);
            } catch (error) {
                console.error("Failed to load files:", error);
            }
        }

        function renderFiles(files) {
            container.innerHTML = "";
            if (files.length === 0) {
                noResultsMessage.classList.remove("hidden");
                return;
            }

            noResultsMessage.classList.add("hidden");
            const fragment = document.createDocumentFragment();

            files.forEach(file => {
                const filename = file.filename || "Unknown File";
                const fileType = file.type || "PDF";
                const status = file.status || "Complete";

                const fileElement = document.createElement("div");
                fileElement.className = "bg-white rounded-lg p-4 border border-orange-500";
                fileElement.dataset.filename = filename.toLowerCase();
                fileElement.innerHTML = `
                    <div class='flex items-start justify-between mb-4'>
                        <div>
                            <h3 class='font-medium truncate'>${filename}</h3>
                        </div>
                    </div>
                    <div class='flex items-center justify-between text-sm'>
                        <span class='text-gray-400'>${fileType}</span>
                        <span class='text-orange-500'>${status}</span>
                    </div>
                    <button class="download-btn mt-3 w-full bg-orange-400 text-white border py-2 rounded-lg hover:bg-blue-600 transition"
                        data-filename="${filename}">
                        Download
                    </button>
                `;
                fragment.appendChild(fileElement);
            });

            container.appendChild(fragment);
        }

        function searchFiles() {
            const query = searchInput.value.toLowerCase();
            const filteredFiles = filesData.filter(file =>
                file.filename.toLowerCase().includes(query)
            );
            renderFiles(filteredFiles);
        }

        searchInput.addEventListener('input', searchFiles);

        // Download functionality
        container.addEventListener('click', async (e) => {
            if (e.target.classList.contains('download-btn')) {
                const filename = e.target.dataset.filename;
                const response = await fetch(`/download/${filename}`);

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                } else {
                    // Custom alert instead of default alert
                    const flashMessage = document.getElementById('flash-message');
                    const bgClass = 'bg-red-100 border-red-500 text-red-700';
                    flashMessage.innerHTML = `<div class="border-l-4 p-4 ${bgClass}">
                        <p class="font-bold">Error</p>
                        <p>Failed to download file.</p>
                    </div>`;
                    flashMessage.classList.remove('hidden');
                    setTimeout(() => {
                        flashMessage.classList.add('hidden');
                    }, 3000);
                }
            }
        });

        loadFiles();
    });
</script>
{% endblock %}
